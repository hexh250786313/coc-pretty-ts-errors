"use strict";var B=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var I=Object.prototype.hasOwnProperty;var $=(e,t)=>{for(var a in t)B(e,a,{get:t[a],enumerable:!0})},C=(e,t,a,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of R(t))!I.call(e,s)&&s!==a&&B(e,s,{get:()=>t[s],enumerable:!(i=H(t,s))||i.enumerable});return e};var O=e=>C(B({},"__esModule",{value:!0}),e);var G={};$(G,{activate:()=>q});module.exports=O(G);var n=require("coc.nvim"),P=require("path"),S=require("pretty-ts-errors-markdown"),v=null,w="pretty-ts-errors",b="tsserver";async function N(e){let{nvim:t}=n.workspace,i=(await t.getOption("runtimepath")).split(","),s=(0,P.join)(e,"runtime");i.includes(s)||await t.command(`execute 'noa set rtp+='.fnameescape('${s.replace(/'/g,"''")}')`),await t.command("call prettytserr#init()")}function A(e){let t=/```[\s\S]*?```/g,a=/`([^`]+)`/g,i=[];return e.replace(t,h=>(i.push(h),"\0")).replace(/</g,"\\<").replace(/>/g,"\\>").replace(a,"\x1B[33m$1\x1B[0m").replace(/\0/g,()=>i.shift()||"")}var L=e=>`\x1B[31m${e}\x1B[0m`,W=e=>`\x1B[32m${e}\x1B[0m`,T=e=>`\x1B[36m${e}\x1B[0m`,F={[n.DiagnosticSeverity.Error]:L,[n.DiagnosticSeverity.Warning]:W,[n.DiagnosticSeverity.Information]:T,[n.DiagnosticSeverity.Hint]:T},M=(e,t)=>e.map(i=>{try{let s=Object.assign({},i),m=A((0,S.formatDiagnostic)(s)).split(`
`).map((r,h)=>{if(h===0&&(r=F[s.severity||n.DiagnosticSeverity.Error](r.substring(3,r.length))),r=r.replace(/(\['+)([^' ]+)('+.+?📄\])\(.+?\)/g,(p,d,o)=>`\x1B[34m${o}\x1B[0m`),t.showLink===!1&&(r=r.replace(/\[(🔗|🌐)\]\(.*\)/g,"")),t.codeBlockHighlightType==="prettytserr")r=r.replace(/(?<=(^\s*```))typescript/,"prettytserr");else{let p=r.match(/^(\s*)```typescript.*/),d=(p==null?void 0:p[1].length)||0;r=r.replace(/(?<=(^\s*```))typescript/,`typescript
${" ".repeat(d)}type Type =`)}return r}).join(`
`);return{...s,message:`${m}

`,filetype:"markdown",source:w}}catch{return i}}).filter(Boolean),E={},l=class l{constructor(t){this.value=t;this.value=t}showInDiagnostic(){return this.value===l.Diagnostic||this.value===l.Both}showInHover(){return this.value===l.Hover||this.value===l.Both}};l.Diagnostic=0,l.Hover=1,l.Both=2;var k=l;async function q(e){let t=n.workspace.getConfiguration(w),a=t.get("enable",!0),i=t.get("showLink",!1),s=t.get("mode",k.Both),m=t.get("codeBlockHighlightType","prettytserr"),r=t.get("serverName",b),h=t.get("experimental.filterOriginalTsErrors",!0);if(b=r,!a)return null;let p=new k(s);n.diagnosticManager.onDidRefresh(()=>{let o=n.services.getService(b);if(!o)return console.warn(`Tsserver not found: serverName '${b}' is not available.`),null;o!==v&&(v=o,v.state===n.ServiceStat.Running?d():v.onServiceReady(d))});let d=()=>{N(e.extensionPath);let o=n.diagnosticManager.create(w),c=n.diagnosticManager.getCollectionByName(r),x=g=>{let u=n.workspace.getDocument(g);if((u==null?void 0:u.bufnr)!==void 0){let y=n.diagnosticManager.buffers.getItem(u==null?void 0:u.bufnr);if(y){let j=n.diagnosticManager.getDiagnostics(y)[r],D=M(j,{showLink:i,codeBlockHighlightType:m});setTimeout(()=>{E[g]=[...D],p.showInDiagnostic()&&(h&&(c.diagnosticsMap.delete(g),y.config.autoRefresh&&y.update(r,[])),o.set(g,D))})}}},f=c==null?void 0:c.diagnosticsMap;f==null||f.forEach((g,u)=>{g.forEach(()=>{x(u)})}),c==null||c.onDidDiagnosticsChange(x)};e.subscriptions.push(n.languages.registerHoverProvider([{language:"javascript"},{language:"javascriptreact"},{language:"javascript.jsx"},{language:"typescript"},{language:"typescriptreact"},{language:"typescript.tsx"},{language:"typescript.jsx"},{language:"jsx-tags"},{language:"jsonc"},{language:"vue"}],{provideHover:(o,c)=>{var f;return p.showInHover()?{contents:(f=E[o.uri])==null?void 0:f.map(g=>z(c,g.range)?{language:"markdown",value:g.message}:null).filter(Boolean)}:null}}))}function z(e,t){let a=!0;return(e.line<t.start.line||e.line>t.end.line)&&(a=!1),e.line===t.start.line&&e.character<t.start.character&&(a=!1),e.line===t.end.line&&e.character>t.end.character&&(a=!1),a}0&&(module.exports={activate});
