"use strict";var k=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var S=(e,t)=>{for(var r in t)k(e,r,{get:t[r],enumerable:!0})},$=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of P(t))!R.call(e,a)&&a!==r&&k(e,a,{get:()=>t[a],enumerable:!(i=H(t,a))||i.enumerable});return e};var C=e=>$(k({},"__esModule",{value:!0}),e);var q={};S(q,{activate:()=>F});module.exports=C(q);var n=require("coc.nvim"),T=require("path"),E=require("pretty-ts-errors-markdown"),x="pretty-ts-errors",y="tsserver";async function I(e){let{nvim:t}=n.workspace,i=(await t.getOption("runtimepath")).split(","),a=(0,T.join)(e,"runtime");i.includes(a)||await t.command(`execute 'noa set rtp+='.fnameescape('${a.replace(/'/g,"''")}')`),await t.command("call prettytserr#init()")}function O(e){let t=/```[\s\S]*?```/g,r=/`([^`]+)`/g,i=[];return e.replace(t,l=>(i.push(l),"\0")).replace(/</g,"\\<").replace(/>/g,"\\>").replace(r,"\x1B[33m$1\x1B[0m").replace(/\0/g,()=>i.shift()||"")}var N=e=>`\x1B[31m${e}\x1B[0m`,A=e=>`\x1B[32m${e}\x1B[0m`,w=e=>`\x1B[36m${e}\x1B[0m`,L={[n.DiagnosticSeverity.Error]:N,[n.DiagnosticSeverity.Warning]:A,[n.DiagnosticSeverity.Information]:w,[n.DiagnosticSeverity.Hint]:w},W=(e,t)=>e.map(i=>{let a=Object.assign({},i),m=O((0,E.formatDiagnostic)(a)).split(`
`).map((s,l)=>{if(l===0&&(s=L[a.severity||n.DiagnosticSeverity.Error](s.substring(3,s.length))),s=s.replace(/(\['+)([^' ]+)('+.+?ğŸ“„\])\(.+?\)/g,(g,h,p)=>`\x1B[34m${p}\x1B[0m`),t.showLink===!1&&(s=s.replace(/\[(ğŸ”—|ğŸŒ)\]\(.*\)/g,"")),t.codeBlockHighlightType==="prettytserr")s=s.replace(/(?<=(^\s*```))typescript/,"prettytserr");else{let g=s.match(/^(\s*)```typescript.*/),h=(g==null?void 0:g[1].length)||0;s=s.replace(/(?<=(^\s*```))typescript/,`typescript
${" ".repeat(h)}type Type =`)}return s}).join(`
`);return{...a,message:`${m}

`,filetype:"markdown",source:x}}),D={},c=class c{constructor(t){this.value=t;this.value=t}showInDiagnostic(){return this.value===c.Diagnostic||this.value===c.Both}showInHover(){return this.value===c.Hover||this.value===c.Both}};c.Diagnostic=0,c.Hover=1,c.Both=2;var v=c;async function F(e){let t=n.workspace.getConfiguration(x),r=t.get("enable",!0),i=t.get("showLink",!1),a=t.get("mode",v.Both),m=t.get("codeBlockHighlightType","prettytserr"),s=t.get("serverName",y);if(y=s,!r)return null;let l=new v(a),g=n.services.getService(y),h=t.get("experimental.filterOriginalTsErrors",!0);if(!g)return console.error(`Tsserver not found: serverName '${y}' is not available.`),null;g.onServiceReady(()=>{I(e.extensionPath);let p=n.diagnosticManager.create(x),u=n.diagnosticManager.getCollectionByName(s);u==null||u.onDidDiagnosticsChange(f=>{let o=n.workspace.getDocument(f);if((o==null?void 0:o.bufnr)!==void 0){let d=n.diagnosticManager.buffers.getItem(o==null?void 0:o.bufnr);if(d){let j=n.diagnosticManager.getDiagnostics(d)[s],B=W(j,{showLink:i,codeBlockHighlightType:m});setTimeout(()=>{D[f]=[...B],l.showInDiagnostic()&&(h&&(u.diagnosticsMap.delete(f),d.config.autoRefresh&&d.update(s,[])),p.set(f,B))})}}})}),e.subscriptions.push(n.languages.registerHoverProvider([{language:"javascript"},{language:"javascriptreact"},{language:"javascript.jsx"},{language:"typescript"},{language:"typescriptreact"},{language:"typescript.tsx"},{language:"typescript.jsx"},{language:"jsx-tags"},{language:"jsonc"},{language:"vue"}],{provideHover:(p,u)=>{var o;return l.showInHover()?{contents:(o=D[p.uri])==null?void 0:o.map(b=>M(u,b.range)?{language:"markdown",value:b.message}:null).filter(Boolean)}:null}}))}function M(e,t){let r=!0;return(e.line<t.start.line||e.line>t.end.line)&&(r=!1),e.line===t.start.line&&e.character<t.start.character&&(r=!1),e.line===t.end.line&&e.character>t.end.character&&(r=!1),r}0&&(module.exports={activate});
