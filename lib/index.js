"use strict";var k=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var P=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var S=(e,t)=>{for(var a in t)k(e,a,{get:t[a],enumerable:!0})},$=(e,t,a,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of P(t))!R.call(e,n)&&n!==a&&k(e,n,{get:()=>t[n],enumerable:!(i=H(t,n))||i.enumerable});return e};var C=e=>$(k({},"__esModule",{value:!0}),e);var q={};S(q,{activate:()=>F});module.exports=C(q);var s=require("coc.nvim"),T=require("path"),E=require("pretty-ts-errors-markdown"),x="pretty-ts-errors",y="tsserver";async function I(e){let{nvim:t}=s.workspace,i=(await t.getOption("runtimepath")).split(","),n=(0,T.join)(e,"runtime");i.includes(n)||await t.command(`execute 'noa set rtp+='.fnameescape('${n.replace(/'/g,"''")}')`),await t.command("call prettytserr#init()")}function O(e){let t=/```[\s\S]*?```/g,a=/`([^`]+)`/g,i=[];return e.replace(t,l=>(i.push(l),"\0")).replace(/</g,"\\<").replace(/>/g,"\\>").replace(a,"\x1B[33m$1\x1B[0m").replace(/\0/g,()=>i.shift()||"")}var N=e=>`\x1B[31m${e}\x1B[0m`,A=e=>`\x1B[32m${e}\x1B[0m`,w=e=>`\x1B[36m${e}\x1B[0m`,L={[s.DiagnosticSeverity.Error]:N,[s.DiagnosticSeverity.Warning]:A,[s.DiagnosticSeverity.Information]:w,[s.DiagnosticSeverity.Hint]:w},W=(e,t)=>e.map(i=>{try{let n=Object.assign({},i),m=O((0,E.formatDiagnostic)(n)).split(`
`).map((r,l)=>{if(l===0&&(r=L[n.severity||s.DiagnosticSeverity.Error](r.substring(3,r.length))),r=r.replace(/(\['+)([^' ]+)('+.+?ğŸ“„\])\(.+?\)/g,(g,h,p)=>`\x1B[34m${p}\x1B[0m`),t.showLink===!1&&(r=r.replace(/\[(ğŸ”—|ğŸŒ)\]\(.*\)/g,"")),t.codeBlockHighlightType==="prettytserr")r=r.replace(/(?<=(^\s*```))typescript/,"prettytserr");else{let g=r.match(/^(\s*)```typescript.*/),h=(g==null?void 0:g[1].length)||0;r=r.replace(/(?<=(^\s*```))typescript/,`typescript
${" ".repeat(h)}type Type =`)}return r}).join(`
`);return{...n,message:`${m}

`,filetype:"markdown",source:x}}catch{return i}}).filter(Boolean),D={},c=class c{constructor(t){this.value=t;this.value=t}showInDiagnostic(){return this.value===c.Diagnostic||this.value===c.Both}showInHover(){return this.value===c.Hover||this.value===c.Both}};c.Diagnostic=0,c.Hover=1,c.Both=2;var v=c;async function F(e){let t=s.workspace.getConfiguration(x),a=t.get("enable",!0),i=t.get("showLink",!1),n=t.get("mode",v.Both),m=t.get("codeBlockHighlightType","prettytserr"),r=t.get("serverName",y);if(y=r,!a)return null;let l=new v(n),g=s.services.getService(y),h=t.get("experimental.filterOriginalTsErrors",!0);if(!g)return console.error(`Tsserver not found: serverName '${y}' is not available.`),null;g.onServiceReady(()=>{I(e.extensionPath);let p=s.diagnosticManager.create(x),u=s.diagnosticManager.getCollectionByName(r);u==null||u.onDidDiagnosticsChange(f=>{let o=s.workspace.getDocument(f);if((o==null?void 0:o.bufnr)!==void 0){let d=s.diagnosticManager.buffers.getItem(o==null?void 0:o.bufnr);if(d){let j=s.diagnosticManager.getDiagnostics(d)[r],B=W(j,{showLink:i,codeBlockHighlightType:m});setTimeout(()=>{D[f]=[...B],l.showInDiagnostic()&&(h&&(u.diagnosticsMap.delete(f),d.config.autoRefresh&&d.update(r,[])),p.set(f,B))})}}})}),e.subscriptions.push(s.languages.registerHoverProvider([{language:"javascript"},{language:"javascriptreact"},{language:"javascript.jsx"},{language:"typescript"},{language:"typescriptreact"},{language:"typescript.tsx"},{language:"typescript.jsx"},{language:"jsx-tags"},{language:"jsonc"},{language:"vue"}],{provideHover:(p,u)=>{var o;return l.showInHover()?{contents:(o=D[p.uri])==null?void 0:o.map(b=>M(u,b.range)?{language:"markdown",value:b.message}:null).filter(Boolean)}:null}}))}function M(e,t){let a=!0;return(e.line<t.start.line||e.line>t.end.line)&&(a=!1),e.line===t.start.line&&e.character<t.start.character&&(a=!1),e.line===t.end.line&&e.character>t.end.character&&(a=!1),a}0&&(module.exports={activate});
