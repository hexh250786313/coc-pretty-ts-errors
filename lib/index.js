"use strict";var x=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var I=(e,t)=>{for(var i in t)x(e,i,{get:t[i],enumerable:!0})},$=(e,t,i,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of H(t))!R.call(e,s)&&s!==i&&x(e,s,{get:()=>t[s],enumerable:!(a=j(t,s))||a.enumerable});return e};var C=e=>$(x({},"__esModule",{value:!0}),e);var z={};I(z,{activate:()=>M});module.exports=C(z);var n=require("coc.nvim"),P=require("path"),S=require("pretty-ts-errors-markdown"),y=null,B="pretty-ts-errors",v="tsserver";async function O(e){let{nvim:t}=n.workspace,a=(await t.getOption("runtimepath")).split(","),s=(0,P.join)(e,"runtime");a.includes(s)||await t.command(`execute 'noa set rtp+='.fnameescape('${s.replace(/'/g,"''")}')`),await t.command("call prettytserr#init()")}function N(e){let t=/```[\s\S]*?```/g,i=/`([^`]+)`/g,a=[];return e.replace(t,p=>(a.push(p),"\0")).replace(/</g,"\\<").replace(/>/g,"\\>").replace(i,"\x1B[33m$1\x1B[0m").replace(/\0/g,()=>a.shift()||"")}var A=e=>`\x1B[31m${e}\x1B[0m`,L=e=>`\x1B[32m${e}\x1B[0m`,D=e=>`\x1B[36m${e}\x1B[0m`,W={[n.DiagnosticSeverity.Error]:A,[n.DiagnosticSeverity.Warning]:L,[n.DiagnosticSeverity.Information]:D,[n.DiagnosticSeverity.Hint]:D},F=(e,t)=>e.map(a=>{try{let s=Object.assign({},a),h=N((0,S.formatDiagnostic)(s)).split(`
`).map((r,p)=>{if(p===0&&(r=W[s.severity||n.DiagnosticSeverity.Error](r.substring(3,r.length))),r=r.replace(/(\['+)([^' ]+)('+.+?📄\])\(.+?\)/g,(l,f,o)=>`\x1B[34m${o}\x1B[0m`),t.showLink===!1&&(r=r.replace(/\[(🔗|🌐)\]\(.*\)/g,"")),t.codeBlockHighlightType==="prettytserr")r=r.replace(/(?<=(^\s*```))typescript/,"prettytserr");else{let l=r.match(/^(\s*)```typescript.*/),f=(l==null?void 0:l[1].length)||0;r=r.replace(/(?<=(^\s*```))typescript/,`typescript
${" ".repeat(f)}type Type =`)}return r}).join(`
`);return{...s,message:`${h}

`,filetype:"markdown",source:B}}catch{return a}}).filter(Boolean),T={},g=class g{constructor(t){this.value=t;this.value=t}showInDiagnostic(){return this.value===g.Diagnostic||this.value===g.Both}showInHover(){return this.value===g.Hover||this.value===g.Both}};g.Diagnostic=0,g.Hover=1,g.Both=2;var b=g;async function M(e){let t=n.workspace.getConfiguration(B),i=t.get("enable",!0),a=t.get("showLink",!1),s=t.get("mode",b.Both),h=t.get("codeBlockHighlightType","prettytserr"),r=t.get("serverName",v),p=t.get("experimental.filterOriginalTsErrors",!0);if(v=r,!i)return null;let l=new b(s);n.diagnosticManager.onDidRefresh(()=>{let o=n.services.getService(v);if(!o)return console.warn(`Tsserver not found: serverName '${v}' is not available.`),null;o!==y&&(y=o,y.state===n.ServiceStat.Running?f():y.onServiceReady(f))});let f=()=>{O(e.extensionPath);let o=n.diagnosticManager.create(B),u=n.diagnosticManager.getCollectionByName(r);u==null||u.onDidDiagnosticsChange(m=>{let c=n.workspace.getDocument(m);if((c==null?void 0:c.bufnr)!==void 0){let d=n.diagnosticManager.buffers.getItem(c==null?void 0:c.bufnr);if(d){let E=n.diagnosticManager.getDiagnostics(d)[r],w=F(E,{showLink:a,codeBlockHighlightType:h});setTimeout(()=>{T[m]=[...w],l.showInDiagnostic()&&(p&&(u.diagnosticsMap.delete(m),d.config.autoRefresh&&d.update(r,[])),o.set(m,w))})}}})};e.subscriptions.push(n.languages.registerHoverProvider([{language:"javascript"},{language:"javascriptreact"},{language:"javascript.jsx"},{language:"typescript"},{language:"typescriptreact"},{language:"typescript.tsx"},{language:"typescript.jsx"},{language:"jsx-tags"},{language:"jsonc"},{language:"vue"}],{provideHover:(o,u)=>{var c;return l.showInHover()?{contents:(c=T[o.uri])==null?void 0:c.map(k=>q(u,k.range)?{language:"markdown",value:k.message}:null).filter(Boolean)}:null}}))}function q(e,t){let i=!0;return(e.line<t.start.line||e.line>t.end.line)&&(i=!1),e.line===t.start.line&&e.character<t.start.character&&(i=!1),e.line===t.end.line&&e.character>t.end.character&&(i=!1),i}0&&(module.exports={activate});
